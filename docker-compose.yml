version: '3.7'
services:
  memcached:
    image: 'memcached:latest'
    container_name: memcached
    restart: always
    networks:
      backend:
        ipv4_address: 172.20.0.3
  mysql:
    image: 'mysql:latest'
    container_name: mysql
    command: '--default-authentication-plugin=mysql_native_password'
    environment:
      - 'MYSQL_ROOT_PASSWORD=${MYSQL_ROOT_PASSWORD}'
      - 'MYSQL_DATABASE=${MYSQL_DATABASE}'
      - 'MYSQL_USER=${MYSQL_USER}'
      - 'MYSQL_PASSWORD=${MYSQL_PASSWORD}'
    ports:
      - '3306:3306'
    volumes:
      - '${MYSQL_DATA}:/var/lib/mysql'
    restart: always
    networks:
      backend:
        ipv4_address: 172.20.0.6
  mailhog:
    image: 'mailhog/mailhog:latest'
    container_name: mailhog
    ports:
      - '1025:1025'
      - '8025:8025'
    restart: always
    networks:
      backend:
        ipv4_address: 172.20.0.4
  redis:
    image: 'redis:latest'
    container_name: redis
    restart: always
    ports:
      - '6379:6379'
    networks:
      backend:
        ipv4_address: 172.20.0.2
  elasticsearch:
    image: elasticsearch:6.5.4
    container_name: elasticsearch
    volumes:
      - '${ELASTICSEARCH_CONFIG}:/usr/share/elasticsearch'
    ports:
      - '9200:9200'
      - '9300:9300'
    networks:
      backend:
        ipv4_address: 172.20.0.7
  kibana:
    image: kibana:6.5.4
    container_name: kibana
    volumes:
      - '${KIBANA_CONFIG}:/usr/share/kibana/config'
    ports:
      - '5601:5601'
    networks:
      backend:
        ipv4_address: 172.20.0.10
    depends_on:
      - elasticsearch
  filebeat:
    image: docker.elastic.co/beats/filebeat:6.6.0
    container_name: filebeat
    volumes:
      - '${FILEBEAT_CONFIG}:/usr/share/filebeat'
    environment:
      - 'setup.kibana.host=kibana:5601'
      - 'output.elasticsearch.hosts=["elasticsearch:9200"]'
    networks:
      backend:
        ipv4_address: 172.20.0.8
    depends_on:
      - elasticsearch
  webserver:
    image: 'nginx:latest'
    container_name: nginx
    working_dir: /usr/share/nginx/html
    volumes:
      - '${NGINX_ROOT}:/usr/share/nginx/html'
      - '${NGINX_CONFIG}:/etc/nginx'
    restart: always
    ports:
      - '80:80'
      - '443:443'
    networks:
      frontend:
        ipv4_address: 172.10.0.3
    depends_on:
      - php-fpm
  php-fpm:
    build: php-fpm
    container_name: php-fpm
    working_dir: /usr/share/nginx/html
    volumes:
      - '${NGINX_ROOT}:/usr/share/nginx/html'
      - '${PHP_CONFIG}:/usr/local/etc/php'
    restart: always
    environment:
      - 'DATE_TIMEZONE=${DATE_TIMEZONE}'
      - 'DISPLAY_ERRORS=${DISPLAY_ERRORS}'
      - 'SENDMAIL_PATH=${SENDMAIL_PATH}'
    networks:
      frontend:
        ipv4_address: 172.10.0.2
      backend:
        ipv4_address: 172.20.0.5
    depends_on:
      - redis
      - mysql
      - memcached
networks:
  frontend:
    ipam:
      driver: default
      config:
        - subnet: 172.10.0.0/16
  backend:
    ipam:
      driver: default
      config:
        - subnet: 172.20.0.0/16